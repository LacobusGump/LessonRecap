<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Lesson Formatter Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #0f172a;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --shadow: none;
            --shadow-lg: 0 5px 8px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #3730a3 0%, #5b21b6 100%);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            color: var(--text);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
        }
        
        .container {
            max-width: 987px;
            margin: 0 auto;
            padding: 21px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 21px;
        }
        
        .header h1 {
            font-size: 34px;
            font-weight: 600;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
            letter-spacing: -0.01em;
        }
        
        .header .subtitle {
            color: var(--text-light);
            font-size: 21px;
            font-weight: 400;
        }
        
        .main-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 21px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }
        
        .form-section {
            margin-bottom: 13px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text);
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 13px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            color: var(--text);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }
        
        .form-input::placeholder {
            color: var(--text-light);
        }
        
        .form-textarea {
            min-height: 200px;
            resize: vertical;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 13px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 13px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .output-section {
            margin-top: 13px;
        }
        
        .output-content {
            background: var(--bg-secondary);
            padding: 13px;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            min-height: 144px;
            font-family: inherit;
            line-height: 1.5;
            border: 1px solid var(--border);
            color: var(--text);
            position: relative;
            font-size: 14px;
        }
        
        .output-content.finalized {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent);
        }
        
        .finalize-bar {
            display: none;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 8px;
            border-bottom: 1px solid var(--border);
            text-align: right;
        }
        
        .finalize-bar.show {
            display: block;
        }
        
        .output-content.finalized .finalize-bar {
            display: none;
        }
        
        .history-section {
            margin-top: 13px;
            padding-top: 13px;
            border-top: 1px solid var(--border);
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 8px;
            border: 1px solid var(--border);
        }
        
        .history-item {
            padding: 5px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .examples-section {
            margin-top: 13px;
            padding-top: 13px;
            border-top: 1px solid var(--border);
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(144px, 1fr));
            gap: 8px;
            margin-top: 8px;
        }
        
        .example-btn {
            padding: 8px 13px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            color: var(--text);
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .example-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .processing-indicator {
            display: none;
            align-items: center;
            gap: 5px;
            color: var(--primary);
            font-weight: 500;
            margin-top: 8px;
        }
        
        .spinner {
            width: 13px;
            height: 13px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            display: none;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--border-radius);
            color: var(--danger);
            margin-top: 8px;
            align-items: center;
            gap: 5px;
        }
        
        .success-message {
            display: none;
            padding: 8px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--border-radius);
            color: var(--accent);
            margin-top: 8px;
            align-items: center;
            gap: 5px;
        }
        
        .char-count {
            text-align: right;
            color: var(--text-light);
            font-size: 13px;
            margin-top: 5px;
        }
        
        .char-count.warning {
            color: var(--warning);
        }
        
        .char-count.danger {
            color: var(--danger);
        }
        
        .checklist-section {
            margin-top: 13px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .check-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .check-item:last-child {
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 13px;
            }
            
            .header h1 {
                font-size: 21px;
            }
            
            .main-card {
                padding: 13px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .examples-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Music Lesson Formatter Pro</h1>
            <p class="subtitle">Transform raw lesson notes into professional recaps</p>
        </div>
        
        <div class="main-card">
            <div class="form-section">
                <label class="form-label" for="studentName">Student Name</label>
                <input
                    type="text"
                    id="studentName"
                    class="form-input"
                    placeholder="Enter student name (e.g., Charleigh)"
                >
            </div>
            
            <div class="form-section">
                <label class="form-label" for="lessonNotes">Enter Raw Lesson Notes</label>
                <textarea
                    id="lessonNotes"
                    class="form-textarea"
                    rows="10"
                    placeholder="Example: worked through Black Sabbath Paranoid which I sent home through the app. You did great with it, went over some of the 16s fills..."
                ></textarea>
                <div class="char-count" id="charCount">0 / 5000 characters</div>
            </div>
            
            <div class="checklist-section">
                <div class="check-item">
                    <input type="checkbox" id="spellCheck" checked>
                    <label for="spellCheck" style="font-size: 12px; color: var(--text-light);">Basic Spellcheck</label>
                </div>
                <div class="check-item">
                    <input type="checkbox" id="grammarCheck" checked>
                    <label for="grammarCheck" style="font-size: 12px; color: var(--text-light);">AI Grammar Proofreading</label>
                </div>
                <div class="check-item">
                    <input type="checkbox" id="offensiveFilter" checked>
                    <label for="offensiveFilter" style="font-size: 12px; color: var(--text-light);">Filter Offensive Words</label>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="formatNotes()" id="formatBtn">
                    Generate Professional Recap
                </button>
                <button class="btn btn-secondary" onclick="proofreadOutput()">
                    Proofread & Edit
                </button>
                <button class="btn btn-secondary" onclick="finalizeNote()">
                    Finalize Note
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    Clear All
                </button>
                <button class="btn btn-secondary" onclick="copyOutput()">
                    Copy Output
                </button>
                <button class="btn btn-secondary" onclick="viewHistory()">
                    View History
                </button>
            </div>
            
            <div class="processing-indicator" id="processing">
                <div class="spinner"></div>
                Processing...
            </div>
            
            <div class="error-message" id="errorMessage">
                <span>⚠️</span>
                <span id="errorText">An error occurred</span>
            </div>
            
            <div class="success-message" id="successMessage">
                <span>✅</span>
                <span id="successText">Operation successful</span>
            </div>
            
            <div class="output-section">
                <label class="form-label">Professional Lesson Recap</label>
                <div class="finalize-bar" id="finalizeBar">
                    <button class="btn btn-primary" onclick="finalizeNote()" style="font-size: 12px; padding: 4px 8px;">Finalize & Save</button>
                    <span style="color: var(--text-light); font-size: 12px; margin-right: auto;">Draft - Click to finalize</span>
                </div>
                <div id="output" class="output-content">Your formatted lesson recap will appear here...</div>
            </div>
            
            <div class="history-section" id="historySection" style="display: none;">
                <label class="form-label">Note History</label>
                <div id="historyList" class="history-list"></div>
            </div>
            
            <div class="examples-section">
                <label class="form-label">Quick Examples (Click to Load)</label>
                <div class="examples-grid">
                    <button class="example-btn" onclick="loadExample('charleigh')">Charleigh - Drums & Fills</button>
                    <button class="example-btn" onclick="loadExample('morgan')">Morgan - Endurance Focus</button>
                    <button class="example-btn" onclick="loadExample('luca')">Luca - Beginner Progress</button>
                    <button class="example-btn" onclick="loadExample('conan')">Conan - Advanced Techniques</button>
                    <button class="example-btn" onclick="loadExample('amaiyah')">Amaiyah - Equipment Discussion</button>
                    <button class="example-btn" onclick="loadExample('brody')">Brody - Multiple Songs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compromise NLP Library for Intelligent Proofreading -->
    <script src="https://unpkg.com/compromise"></script>

    <script>
        // Configuration and Data
        const CONFIG = {
            MAX_HOMEWORK_ITEMS: 4,
            MIN_TEXT_LENGTH: 10,
            MAX_CHARS: 5000,
            MAX_PROCESSING_TIME: 5000,
            DEBOUNCE_DELAY: 300
        };

        const musicTerms = {
            'hh': 'hi-hat',
            'hihat': 'hi-hat',
            'hi hat': 'hi-hat',
            '16s': '16th notes',
            '16ths': '16th notes',
            '8s': '8th notes',
            '8ths': '8th notes',
            'bpm': 'BPM',
            'kick': 'kick drum',
            'bd': 'bass drum',
            'sd': 'snare drum',
            'fill': 'fill',
            'fills': 'fills',
            'groove': 'groove',
            'grooves': 'grooves',
            'beat': 'beat',
            'beats': 'beats',
            'cross stick': 'cross-stick',
            'crossstick': 'cross-stick',
            'rim shot': 'rim shot',
            'rimshot': 'rim shot'
        };

        const spellingCorrections = {
            'metalica': 'Metallica',
            'metallica': 'Metallica',
            'sabath': 'Sabbath',
            'sabbath': 'Sabbath',
            'oma': 'OMA',
            'rhthm': 'rhythm',
            'rythm': 'rhythm',
            'rythem': 'rhythm',
            'brough': 'brought',
            'startwed': 'started',
            'tp': 'to',
            'lite': 'light',
            'avail': 'available',
            'practise': 'practice',
            'practis': 'practice',
            'foccus': 'focus',
            'focuss': 'focus',
            'spead': 'speed',
            'endurence': 'endurance',
            'endurace': 'endurance',
            'techinque': 'technique',
            'technqiue': 'technique',
            'patern': 'pattern',
            'pattrn': 'pattern',
            'creap': 'Creep',
            'paraniod': 'Paranoid',
            'parnoid': 'Paranoid',
            'bosa nova': 'bossa nova',
            'bosa': 'bossa',
            'indepence': 'independence',
            'independance': 'independence',
            'sixtuplets': 'sextuplets',
            'sixtuplet': 'sextuplet'
        };

        // Basic offensive words filter
        const offensiveWords = ['damn', 'hell', 'shit', 'fuck', 'ass', 'bitch'];

        // Basic grammar rules (enhanced with Compromise handling)
        const grammarRules = [
            { pattern: /\bi (\w)/gi, replacement: 'I $1' },
            { pattern: /\b(he|she|it|they|we|you) ([a-z])/gi, replacement: '$1 $2' }
        ];

        // Known songs (abbreviated for brevity; full list as before)
        const knownSongs = {
            'paranoid': { title: 'Paranoid', artist: 'Black Sabbath' },
            // ... (include full expanded list from previous version)
            'we will rock you': { title: 'We Will Rock You', artist: 'Queen' },
            // Add more as needed
        };

        const examples = {
            // ... (same as before)
        };

        class LessonFormatter {
            constructor() {
                this.studentName = '';
                this.achievements = [];
                this.homework = [];
                this.techniques = new Set();
                this.songs = [];
                this.errors = [];
                this.isFinalized = false;
                this.finalizeDate = null;
            }

            reset() {
                this.studentName = '';
                this.achievements = [];
                this.homework = [];
                this.techniques = new Set();
                this.songs = [];
                this.errors = [];
                this.isFinalized = false;
                this.finalizeDate = null;
            }

            preprocessText(text) {
                if (!text) return '';
                
                let processed = text.trim();
                
                // Offensive word filter
                if (document.getElementById('offensiveFilter').checked) {
                    for (const word of offensiveWords) {
                        const regex = new RegExp(`\\b${this.escapeRegex(word)}\\b`, 'gi');
                        processed = processed.replace(regex, '[filtered]');
                    }
                }
                
                // Basic grammar check
                if (document.getElementById('grammarCheck').checked) {
                    for (const rule of grammarRules) {
                        processed = processed.replace(rule.pattern, rule.replacement);
                    }
                }
                
                // Apply spelling corrections
                for (const [wrong, right] of Object.entries(spellingCorrections)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(wrong)}\\b`, 'gi');
                    processed = processed.replace(regex, right);
                }
                
                // Song title replacement (title only)
                for (const [key, data] of Object.entries(knownSongs)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(key)}\\b`, 'gi');
                    processed = processed.replace(regex, data.title);
                }
                
                // Apply music term corrections
                for (const [abbrev, full] of Object.entries(musicTerms)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(abbrev)}\\b`, 'gi');
                    processed = processed.replace(regex, full);
                }
                
                // Clean up spacing and punctuation
                processed = processed
                    .replace(/\s+/g, ' ')
                    .replace(/\s*([,.!?;:])/g, '$1')
                    .replace(/([.!?])\s*([a-z])/g, (match, p1, p2) => `${p1} ${p2.toUpperCase()}`);
                
                return processed;
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            extractStudentName(text) {
                let name = document.getElementById('studentName').value.trim();
                if (name) {
                    this.studentName = this.capitalizeWord(name);
                    return text;
                }
                const nameMatch = text.match(/^([A-Z][a-z]+)\s*[-:–]\s*/i);
                if (nameMatch) {
                    this.studentName = this.capitalizeWord(nameMatch[1]);
                    return text.replace(nameMatch[0], '').trim();
                }
                return text;
            }

            extractSongs(text) {
                // ... (same as previous)
            }

            extractTechniques(text) {
                // ... (same as previous)
            }

            splitIntoParts(text) {
                return text.split(/[.!?;]+/).flatMap(sentence => 
                    sentence.split(',').map(part => part.trim()).filter(part => part.length > 3)
                ).filter(part => part.length > 5);
            }

            parseSentences(text) {
                const cleanText = this.extractStudentName(text);
                const processed = this.preprocessText(cleanText);
                
                this.extractSongs(processed);
                this.extractTechniques(processed);

                const parts = this.splitIntoParts(processed);

                parts.forEach(part => {
                    const classification = this.classifySentence(part);
                    const formatted = this.formatSentence(part, classification);
                    
                    if (formatted) {
                        if (classification === 'achievement') {
                            this.achievements.push(formatted);
                        } else if (classification === 'homework') {
                            this.homework.push(formatted);
                        }
                    }
                });

                this.generateInferredHomework();
            }

            classifySentence(sentence) {
                // ... (same as previous)
            }

            formatSentence(sentence, type) {
                // ... (same as previous, with smart song formatting)
            }

            generateInferredHomework() {
                // ... (same as previous)
            }

            capitalizeWord(word) {
                // ... (same)
            }

            capitalizeProperNouns(text) {
                // ... (same)
            }

            // NEW: Intelligent Proofreading with Compromise
            proofreadText(text) {
                if (!window.nlp || !document.getElementById('grammarCheck').checked) return text;

                let doc = nlp(text);

                // Normalize tense for achievements/homework (assume sections)
                // Past tense for achievements
                doc.match('Today\'s Achievements: #Sentence+').sentences().verbs().toPastTense();

                // Imperative/future for homework
                doc.match('Practice Assignments: #Sentence+').sentences().verbs().toInfinitive();

                // Expand contractions
                doc.contractions().expand();

                // Ensure proper capitalization
                doc.sentences().toTitleCase(); // But selective, as it might overdo—use for new sentences

                // Pluralize nouns if context suggests (simple heuristic)
                doc.nouns().toPlural().if('#Singular'); // Example: adjust based on need

                // Fix common errors: e.g., "which i" -> "which I"
                doc.match('which i').replaceWith('which I');

                return doc.text();
            }

            generateOutput() {
                let output = `Lesson Recap`;
                
                if (this.studentName) {
                    output += ` - ${this.studentName}`;
                }
                
                if (this.finalizeDate) {
                    output += ` (Finalized: ${this.finalizeDate})`;
                }
                
                output += `\n\nToday's Achievements:\n\n`;
                
                if (this.achievements.length > 0) {
                    this.achievements.forEach(achievement => {
                        output += `• ${achievement}\n`;
                    });
                } else {
                    output += `• Successfully completed lesson activities.\n`;
                }
                
                output += `\nPractice Assignments:\n\n`;
                
                this.homework.forEach(hw => {
                    output += `• ${hw}\n`;
                });

                if (this.techniques.size > 2) {
                    output += `\nTechniques Covered:\n\n`;
                    const techniqueList = Array.from(this.techniques).slice(0, 5);
                    techniqueList.forEach(technique => {
                        output += `• ${this.capitalizeProperNouns(technique.charAt(0).toUpperCase() + technique.slice(1))}\n`;
                    });
                }

                // Apply proofreading if enabled
                return this.proofreadText(output);
            }

            saveToHistory() {
                // ... (same)
            }
        }

        // Global formatter instance
        const formatter = new LessonFormatter();

        // NEW: Proofread function for post-generation edits
        function proofreadOutput() {
            const outputEl = document.getElementById('output');
            let currentText = outputEl.textContent;
            if (currentText === 'Your formatted lesson recap will appear here...') {
                showError('Generate a recap first.');
                return;
            }
            showProcessing(true);
            setTimeout(() => {
                const proofread = formatter.proofreadText(currentText);
                outputEl.textContent = proofread;
                showProcessing(false);
                showSuccess('Proofread and edited!');
            }, 100);
        }

        // Main functions (updated to use new generateOutput with proofreading)
        function formatNotes() {
            // ... (same, but now generateOutput includes proofreading)
        }

        // ... (other functions same as previous)

        // Event listeners (same)
    </script>
</body>
</html>
