<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Lesson Formatter Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #0f172a;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --shadow: none;
            --shadow-lg: 0 5px 8px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #3730a3 0%, #5b21b6 100%);
            --border-radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            color: var(--text);
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 14px; /* Increased for better readability */
        }
        
        .container {
            max-width: 987px; /* Fibonacci: 987 */
            margin: 0 auto;
            padding: 21px; /* Fibonacci: 21 */
        }
        
        .header {
            text-align: center;
            margin-bottom: 21px; /* Fibonacci: 21 */
        }
        
        .header h1 {
            font-size: 34px; /* Fibonacci: 34 */
            font-weight: 600;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px; /* Fibonacci: 5 */
            letter-spacing: -0.01em;
        }
        
        .header .subtitle {
            color: var(--text-light);
            font-size: 21px; /* Fibonacci: 21 */
            font-weight: 400;
        }
        
        .main-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 21px; /* Fibonacci: 21 */
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }
        
        .form-section {
            margin-bottom: 13px; /* Fibonacci: 13 */
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px; /* Fibonacci: 5 */
            font-weight: 500;
            color: var(--text);
            font-size: 14px; /* Increased */
        }
        
        .form-input {
            width: 100%;
            padding: 13px; /* Fibonacci: 13 */
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 14px; /* Increased */
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            color: var(--text);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }
        
        .form-input::placeholder {
            color: var(--text-light);
        }
        
        .form-textarea {
            min-height: 200px; /* Increased for larger box */
            resize: vertical;
            font-size: 14px; /* Increased for better text readability */
            line-height: 1.6; /* Improved line spacing */
        }
        
        .button-group {
            display: flex;
            gap: 8px; /* Fibonacci: 8 */
            margin-bottom: 13px; /* Fibonacci: 13 */
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 8px 13px; /* Fibonacci: 8,13 */
            border: none;
            border-radius: var(--border-radius);
            font-size: 13px; /* Fibonacci: 13 */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px; /* Fibonacci: 5 */
            text-decoration: none;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .output-section {
            margin-top: 13px; /* Fibonacci: 13 */
        }
        
        .output-content {
            background: var(--bg-secondary);
            padding: 13px; /* Fibonacci: 13 */
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            min-height: 144px; /* Fibonacci: 144 */
            font-family: inherit;
            line-height: 1.5;
            border: 1px solid var(--border);
            color: var(--text);
            position: relative;
            font-size: 14px; /* Match body */
        }
        
        .output-content.finalized {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--accent);
        }
        
        .finalize-bar {
            display: none;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 8px;
            border-bottom: 1px solid var(--border);
            text-align: right;
        }
        
        .finalize-bar.show {
            display: block;
        }
        
        .output-content.finalized .finalize-bar {
            display: none;
        }
        
        .history-section {
            margin-top: 13px; /* Fibonacci: 13 */
            padding-top: 13px; /* Fibonacci: 13 */
            border-top: 1px solid var(--border);
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 8px;
            border: 1px solid var(--border);
        }
        
        .history-item {
            padding: 5px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-light);
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .examples-section {
            margin-top: 13px; /* Fibonacci: 13 */
            padding-top: 13px; /* Fibonacci: 13 */
            border-top: 1px solid var(--border);
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(144px, 1fr)); /* Fibonacci: 144 */
            gap: 8px; /* Fibonacci: 8 */
            margin-top: 8px; /* Fibonacci: 8 */
        }
        
        .example-btn {
            padding: 8px 13px; /* Fibonacci: 8,13 */
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            color: var(--text);
            font-size: 13px; /* Fibonacci: 13 */
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .example-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .processing-indicator {
            display: none;
            align-items: center;
            gap: 5px; /* Fibonacci: 5 */
            color: var(--primary);
            font-weight: 500;
            margin-top: 8px; /* Fibonacci: 8 */
        }
        
        .spinner {
            width: 13px; /* Fibonacci: 13 */
            height: 13px; /* Fibonacci: 13 */
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            display: none;
            padding: 8px; /* Fibonacci: 8 */
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--border-radius);
            color: var(--danger);
            margin-top: 8px; /* Fibonacci: 8 */
            align-items: center;
            gap: 5px; /* Fibonacci: 5 */
        }
        
        .success-message {
            display: none;
            padding: 8px; /* Fibonacci: 8 */
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--border-radius);
            color: var(--accent);
            margin-top: 8px; /* Fibonacci: 8 */
            align-items: center;
            gap: 5px; /* Fibonacci: 5 */
        }
        
        .char-count {
            text-align: right;
            color: var(--text-light);
            font-size: 13px; /* Fibonacci: 13 */
            margin-top: 5px; /* Fibonacci: 5 */
        }
        
        .char-count.warning {
            color: var(--warning);
        }
        
        .char-count.danger {
            color: var(--danger);
        }
        
        .checklist-section {
            margin-top: 13px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }
        
        .check-item {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .check-item:last-child {
            margin-bottom: 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 13px; /* Fibonacci: 13 */
            }
            
            .header h1 {
                font-size: 21px; /* Fibonacci: 21 */
            }
            
            .main-card {
                padding: 13px; /* Fibonacci: 13 */
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .examples-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎵 Music Lesson Formatter Pro</h1>
            <p class="subtitle">Transform raw lesson notes into professional recaps</p>
        </div>
        
        <div class="main-card">
            <div class="form-section">
                <label class="form-label" for="studentName">Student Name</label>
                <input
                    type="text"
                    id="studentName"
                    class="form-input"
                    placeholder="Enter student name (e.g., Charleigh)"
                >
            </div>
            
            <div class="form-section">
                <label class="form-label" for="lessonNotes">Enter Raw Lesson Notes</label>
                <textarea
                    id="lessonNotes"
                    class="form-textarea"
                    rows="10" <!-- Increased rows for larger box -->
                    placeholder="Example: worked through Black Sabbath Paranoid which I sent home through the app. You did great with it, went over some of the 16s fills..."
                ></textarea>
                <div class="char-count" id="charCount">0 / 5000 characters</div>
            </div>
            
            <div class="checklist-section">
                <div class="check-item">
                    <input type="checkbox" id="spellCheck" checked>
                    <label for="spellCheck" style="font-size: 12px; color: var(--text-light);">Basic Spellcheck</label>
                </div>
                <div class="check-item">
                    <input type="checkbox" id="grammarCheck" checked>
                    <label for="grammarCheck" style="font-size: 12px; color: var(--text-light);">Basic Grammar Suggestions</label>
                </div>
                <div class="check-item">
                    <input type="checkbox" id="offensiveFilter" checked>
                    <label for="offensiveFilter" style="font-size: 12px; color: var(--text-light);">Filter Offensive Words</label>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="formatNotes()" id="formatBtn">
                    Generate Professional Recap
                </button>
                <button class="btn btn-secondary" onclick="finalizeNote()">
                    Finalize Note
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    Clear All
                </button>
                <button class="btn btn-secondary" onclick="copyOutput()">
                    Copy Output
                </button>
                <button class="btn btn-secondary" onclick="viewHistory()">
                    View History
                </button>
            </div>
            
            <div class="processing-indicator" id="processing">
                <div class="spinner"></div>
                Processing...
            </div>
            
            <div class="error-message" id="errorMessage">
                <span>⚠️</span>
                <span id="errorText">An error occurred</span>
            </div>
            
            <div class="success-message" id="successMessage">
                <span>✅</span>
                <span id="successText">Operation successful</span>
            </div>
            
            <div class="output-section">
                <label class="form-label">Professional Lesson Recap</label>
                <div class="finalize-bar" id="finalizeBar">
                    <button class="btn btn-primary" onclick="finalizeNote()" style="font-size: 12px; padding: 4px 8px;">Finalize & Save</button>
                    <span style="color: var(--text-light); font-size: 12px; margin-right: auto;">Draft - Click to finalize</span>
                </div>
                <div id="output" class="output-content">Your formatted lesson recap will appear here...</div>
            </div>
            
            <div class="history-section" id="historySection" style="display: none;">
                <label class="form-label">Note History</label>
                <div id="historyList" class="history-list"></div>
            </div>
            
            <div class="examples-section">
                <label class="form-label">Quick Examples (Click to Load)</label>
                <div class="examples-grid">
                    <button class="example-btn" onclick="loadExample('charleigh')">Charleigh - Drums & Fills</button>
                    <button class="example-btn" onclick="loadExample('morgan')">Morgan - Endurance Focus</button>
                    <button class="example-btn" onclick="loadExample('luca')">Luca - Beginner Progress</button>
                    <button class="example-btn" onclick="loadExample('conan')">Conan - Advanced Techniques</button>
                    <button class="example-btn" onclick="loadExample('amaiyah')">Amaiyah - Equipment Discussion</button>
                    <button class="example-btn" onclick="loadExample('brody')">Brody - Multiple Songs</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration and Data
        const CONFIG = {
            MAX_HOMEWORK_ITEMS: 4,
            MIN_TEXT_LENGTH: 10,
            MAX_CHARS: 5000, // Added limit for character count
            MAX_PROCESSING_TIME: 5000,
            DEBOUNCE_DELAY: 300
        };

        const musicTerms = {
            'hh': 'hi-hat',
            'hihat': 'hi-hat',
            'hi hat': 'hi-hat',
            '16s': '16th notes',
            '16ths': '16th notes',
            '8s': '8th notes',
            '8ths': '8th notes',
            'bpm': 'BPM',
            'kick': 'kick drum',
            'bd': 'bass drum',
            'sd': 'snare drum',
            'fill': 'fill',
            'fills': 'fills',
            'groove': 'groove',
            'grooves': 'grooves',
            'beat': 'beat',
            'beats': 'beats',
            'cross stick': 'cross-stick',
            'crossstick': 'cross-stick',
            'rim shot': 'rim shot',
            'rimshot': 'rim shot'
        };

        const spellingCorrections = {
            'metalica': 'Metallica',
            'metallica': 'Metallica',
            'sabath': 'Sabbath',
            'sabbath': 'Sabbath',
            'oma': 'OMA',
            'rhthm': 'rhythm',
            'rythm': 'rhythm',
            'rythem': 'rhythm',
            'brough': 'brought',
            'startwed': 'started',
            'tp': 'to',
            'lite': 'light',
            'avail': 'available',
            'practise': 'practice',
            'practis': 'practice',
            'foccus': 'focus',
            'focuss': 'focus',
            'spead': 'speed',
            'endurence': 'endurance',
            'endurace': 'endurance',
            'techinque': 'technique',
            'technqiue': 'technique',
            'patern': 'pattern',
            'pattrn': 'pattern',
            'creap': 'Creep',
            'paraniod': 'Paranoid',
            'parnoid': 'Paranoid',
            'bosa nova': 'bossa nova',
            'bosa': 'bossa',
            'indepence': 'independence',
            'independance': 'independence',
            'sixtuplets': 'sextuplets',
            'sixtuplet': 'sextuplet'
        };

        // Basic offensive words filter (expandable dictionary)
        const offensiveWords = ['damn', 'hell', 'shit', 'fuck', 'ass', 'bitch']; // Placeholder; expand as needed

        // Basic grammar rules (simple suggestions)
        const grammarRules = [
            { pattern: /\bi (\w)/gi, replacement: 'I $1' },
            { pattern: /(\w+)ed (\w+)/gi, replacement: '$1ed, $2' }, // Basic comma suggestion
            { pattern: /\b(he|she|it|they|we|you) (\w+)/gi, replacement: '$1 $2' } // Basic capitalization after pronouns
        ];

        const knownSongs = {
            'paranoid': { title: 'Paranoid', artist: 'Black Sabbath' },
            'running': { title: 'Running', artist: 'OMA' },
            'friday im in love': { title: "Friday I'm In Love", artist: 'The Cure' },
            'seven nation army': { title: 'Seven Nation Army', artist: 'The White Stripes' },
            'radioactive': { title: 'Radioactive', artist: 'Imagine Dragons' },
            'i will survive': { title: 'I Will Survive', artist: 'Gloria Gaynor' },
            'master of puppets': { title: 'Master of Puppets', artist: 'Metallica' },
            'creep': { title: 'Creep', artist: 'Radiohead' },
            'cream': { title: 'CREAM', artist: 'OMA' },
            'seek and destroy': { title: 'Seek & Destroy', artist: 'Metallica' },
            'seek & destroy': { title: 'Seek & Destroy', artist: 'Metallica' },
            'something just like this': { title: 'Something Just Like This', artist: 'The Chainsmokers & Coldplay' },
            'bones': { title: 'Bones', artist: 'Imagine Dragons' },
            'too sweet': { title: 'Too Sweet', artist: 'Hozier' },
            // Expanded list from popular drum songs
            'enter sandman': { title: 'Enter Sandman', artist: 'Metallica' },
            'walk this way': { title: 'Walk This Way', artist: 'Aerosmith' },
            'rock n roll': { title: 'Rock and Roll', artist: 'Led Zeppelin' },
            'back in black': { title: 'Back In Black', artist: 'AC/DC' },
            'come together': { title: 'Come Together', artist: 'The Beatles' },
            'funky drummer': { title: 'Funky Drummer Pt. 1', artist: 'James Brown' },
            'take five': { title: 'Take Five', artist: 'The Dave Brubeck Quartet' },
            'clint eastwood': { title: 'Clint Eastwood', artist: 'Gorillaz' },
            'blitzkrieg bop': { title: 'Blitzkrieg Bop', artist: 'Ramones' },
            'livin on a prayer': { title: "Livin' on a Prayer", artist: 'Bon Jovi' },
            'clocks': { title: 'Clocks', artist: 'Coldplay' },
            'my hero': { title: 'My Hero', artist: 'Foo Fighters' },
            'castle on the hill': { title: 'Castle On The Hill', artist: 'Ed Sheeran' },
            'shape of you': { title: 'Shape of You', artist: 'Ed Sheeran' },
            'starboy': { title: 'Starboy', artist: 'The Weeknd' },
            'skin': { title: 'Skin', artist: 'Rihanna' },
            'all i want': { title: 'All I Want', artist: 'Skunk Anansie' },
            'all my life': { title: 'All My Life', artist: 'Foo Fighters' },
            'all right now': { title: 'All Right Now', artist: 'Free' },
            'always on the run': { title: 'Always On The Run', artist: 'Lenny Kravitz' },
            'purple rain': { title: 'Purple Rain', artist: 'Prince' },
            'comfortably numb': { title: 'Comfortably Numb', artist: 'Pink Floyd' },
            'knockin on heaven door': { title: "Knockin' on Heaven's Door", artist: "Guns N' Roses" },
            'rocket man': { title: 'Rocket Man', artist: 'Elton John' },
            'green river': { title: 'Green River', artist: 'Creedence Clearwater Revival' },
            'aja': { title: 'Aja', artist: 'Steely Dan' },
            'we will rock you': { title: 'We Will Rock You', artist: 'Queen' }
        };

        const examples = {
            charleigh: `Charleigh - Worked through Black sabath Paranoid which i sent home through the app. you did great with it, went over some of the 16s fills which brough us into playing 16s to a metronome! Startwed at 100bpm and worked it up to 170. great job, try to keep everything nice and balanced`,
            morgan: `Morgan - Worked through The Cure - Friday I'm In Love. We played through first at 90% speed then cranked it out at full. spoke about technique with hh and keeping it light so we can play through the whole song. keep your kick nice and steady`,
            luca: `Luca - Went through triplets from 60-70bpm. doing great, try for 80 next week. played through seven nation army, just the chorus. played through radioactive which sounds very good! lastly started to learn i will survive`,
            conan: `Conan - Worked through bosa nova, playing it to different songs but looking to keep it nice and consistent. Then we broke into master of puppets by metalica and worked out timing. sounding really good. lastly went through some foot techniques`,
            amaiyah: `Amaiyah - worked through creep, broke down the main patterns including the cross stick. Went through learning sixtuplets. for sticking its 6 hits on the snare then 2, 2, 2 starting on the snare, tom, low tom. spoke about what kind of drum kit to get which i suggest not spend over $500 to start`,
            brody: `Brody played through The Chainsmokers & Coldplay - Something Just Like This and picked out the kick pattern in the chorus. Also played Bones by Imagine Dragons and too sweet by hozier`
        };

        class LessonFormatter {
            constructor() {
                this.studentName = '';
                this.achievements = [];
                this.homework = [];
                this.techniques = new Set();
                this.songs = [];
                this.errors = [];
                this.isFinalized = false;
                this.finalizeDate = null;
            }

            reset() {
                this.studentName = '';
                this.achievements = [];
                this.homework = [];
                this.techniques = new Set();
                this.songs = [];
                this.errors = [];
                this.isFinalized = false;
                this.finalizeDate = null;
            }

            preprocessText(text) {
                if (!text) return '';
                
                let processed = text.trim();
                
                // Offensive word filter
                if (document.getElementById('offensiveFilter').checked) {
                    for (const word of offensiveWords) {
                        const regex = new RegExp(`\\b${this.escapeRegex(word)}\\b`, 'gi');
                        processed = processed.replace(regex, '[filtered]');
                    }
                }
                
                // Basic grammar check
                if (document.getElementById('grammarCheck').checked) {
                    for (const rule of grammarRules) {
                        processed = processed.replace(rule.pattern, rule.replacement);
                    }
                }
                
                // Apply spelling corrections
                for (const [wrong, right] of Object.entries(spellingCorrections)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(wrong)}\\b`, 'gi');
                    processed = processed.replace(regex, right);
                }
                
                // NEW: Auto-replace known song mentions with full title/artist for better recognition
                for (const [key, data] of Object.entries(knownSongs)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(key)}\\b`, 'gi');
                    const replacement = `${data.title}${data.artist ? ` by ${data.artist}` : ''}`;
                    processed = processed.replace(regex, replacement);
                }
                
                // Apply music term corrections
                for (const [abbrev, full] of Object.entries(musicTerms)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(abbrev)}\\b`, 'gi');
                    processed = processed.replace(regex, full);
                }
                
                // Clean up spacing
                processed = processed
                    .replace(/\s+/g, ' ')
                    .replace(/\s*([,.!?])/g, '$1')
                    .replace(/([.!?])\s*([a-z])/g, (match, p1, p2) => `${p1} ${p2.toUpperCase()}`);
                
                return processed;
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            extractStudentName(text) {
                let name = document.getElementById('studentName').value.trim();
                if (name) {
                    this.studentName = this.capitalizeWord(name);
                    return text;
                }
                const nameMatch = text.match(/^([A-Z][a-z]+)\s*[-:–]\s*/i);
                if (nameMatch) {
                    this.studentName = this.capitalizeWord(nameMatch[1]);
                    return text.replace(nameMatch[0], '').trim();
                }
                return text;
            }

            extractSongs(text) {
                // Enhanced: Since we preprocess to include full song names, extraction can be more robust
                // But keep patterns for structured mentions
                const patterns = [
                    /(?:worked through|played through|started learning|learned|practiced|played)\s+([^,.!?]+?)(?:\s+by\s+([^,.!?]+?))?(?:[,.!?]|$)/gi,
                    /(?:song|track)\s+["']?([^"',.!?]+?)["']?(?:\s+by\s+([^,.!?]+?))?(?:[,.!?]|$)/gi
                ];

                for (const pattern of patterns) {
                    let match;
                    while ((match = pattern.exec(text)) !== null) {
                        let songTitle = match[1].trim();
                        let artist = match[2] ? match[2].trim() : '';

                        if (!artist && songTitle.includes('-')) {
                            const parts = songTitle.split('-').map(p => p.trim());
                            if (parts.length === 2) {
                                artist = parts[0];
                                songTitle = parts[1];
                            }
                        }

                        songTitle = this.capitalizeProperNouns(songTitle);
                        artist = artist ? this.capitalizeProperNouns(artist) : '';

                        if (songTitle && !songTitle.match(/^(it|this|that|them|the|a|an)$/i)) {
                            this.songs.push({ title: songTitle, artist });
                        }
                    }
                }

                // Remove duplicates
                const uniqueSongs = new Map();
                this.songs.forEach(song => {
                    const key = song.title.toLowerCase();
                    if (!uniqueSongs.has(key)) {
                        uniqueSongs.set(key, song);
                    }
                });
                this.songs = Array.from(uniqueSongs.values());
            }

            extractTechniques(text) {
                const patterns = [
                    /\b\d+(?:\s*-\s*\d+)?\s*bpm\b/gi,
                    /\btriplets?\b/gi,
                    /\bsextuplets?\b/gi,
                    /\b16th\s+notes?\b/gi,
                    /\b8th\s+notes?\b/gi,
                    /\bcross[\s-]?stick\b/gi,
                    /\bkick\s+(?:drum|independence|pattern)?\b/gi,
                    /\bhi[\s-]?hat\b/gi,
                    /\bfills?\b/gi,
                    /\bgrooves?\b/gi,
                    /\bbeats?\b/gi,
                    /\bbossa\s+nova\b/gi,
                    /\bendurance\b/gi,
                    /\bmetronome\b/gi,
                    /\bindependence\b/gi
                ];

                patterns.forEach(pattern => {
                    const matches = text.match(pattern);
                    if (matches) {
                        matches.forEach(match => {
                            this.techniques.add(match.toLowerCase());
                        });
                    }
                });
            }

            parseSentences(text) {
                const cleanText = this.extractStudentName(text);
                const processed = this.preprocessText(cleanText);
                
                this.extractSongs(processed);
                this.extractTechniques(processed);

                // Split into sentences
                const sentences = processed
                    .split(/[.!?]+/)
                    .map(s => s.trim())
                    .filter(s => s.length > 5);

                sentences.forEach(sentence => {
                    const classification = this.classifySentence(sentence);
                    const formatted = this.formatSentence(sentence, classification);
                    
                    if (formatted) {
                        if (classification === 'achievement') {
                            this.achievements.push(formatted);
                        } else if (classification === 'homework') {
                            this.homework.push(formatted);
                        }
                    }
                });

                this.generateInferredHomework();
            }

            classifySentence(sentence) {
                const lower = sentence.toLowerCase();
                
                const achievementKeywords = [
                    'worked', 'played', 'went through', 'learned', 'started',
                    'practiced', 'broke down', 'covered', 'sounds', 'sounding', // Added 'sounding' for better recognition
                    'good', 'great', 'excellent', 'awesome'
                ];
                
                const homeworkKeywords = [
                    'try', 'keep', 'practice', 'work on', 'focus on',
                    'next week', 'homework', 'continue', 'maintain'
                ];

                if (achievementKeywords.some(keyword => lower.includes(keyword))) {
                    return 'achievement';
                }
                
                if (homeworkKeywords.some(keyword => lower.includes(keyword))) {
                    return 'homework';
                }
                
                return 'other';
            }

            formatSentence(sentence, type) {
                if (!sentence) return '';
                
                let formatted = sentence.trim();
                
                // Capitalize first letter
                formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                
                // Convert to "we" language for achievements
                if (type === 'achievement') {
                    if (!formatted.match(/^(We|Today|This|First|Then|Also|Additionally)/i)) {
                        if (formatted.match(/^(Worked|Played|Started|Learned|Practiced|Went|Focused|Covered)/i)) {
                            formatted = 'We ' + formatted.toLowerCase();
                            formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                        }
                    }
                }
                
                // Format song references without quotes (now handled in preprocess)
                this.songs.forEach(song => {
                    const pattern = new RegExp(`\\b${this.escapeRegex(song.title)}\\b`, 'gi');
                    const replacement = song.artist ? 
                        `${song.title} by ${song.artist}` : 
                        `${song.title}`;
                    formatted = formatted.replace(pattern, replacement);
                });
                
                // Ensure sentence ends properly
                if (!formatted.match(/[.!?]$/)) {
                    formatted += '.';
                }
                
                return formatted;
            }

            generateInferredHomework() {
                // Add specific homework based on content
                if (this.songs.length > 0 && this.homework.length < 2) {
                    const song = this.songs[0];
                    const songRef = song.artist ? 
                        `${song.title} by ${song.artist}` : 
                        `${song.title}`;
                    this.homework.push(`Practice ${songRef} focusing on accuracy and timing.`);
                }

                if (this.techniques.has('metronome') || Array.from(this.techniques).some(t => t.includes('bpm'))) {
                    this.homework.push('Continue metronome practice to build consistency.');
                }

                if (this.techniques.has('fills') || this.techniques.has('16th notes')) {
                    this.homework.push('Work on drum fills, starting slowly and building speed.');
                }

                if (this.homework.length === 0) {
                    this.homework.push('Practice the material covered in today\'s lesson.');
                    this.homework.push('Focus on maintaining proper technique and timing.');
                }

                // Remove duplicates and limit
                this.homework = [...new Set(this.homework)].slice(0, CONFIG.MAX_HOMEWORK_ITEMS);
            }

            capitalizeWord(word) {
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }

            capitalizeProperNouns(text) {
                const properNouns = {
                    'metallica': 'Metallica',
                    'sabbath': 'Sabbath',
                    'oma': 'OMA',
                    'the cure': 'The Cure',
                    'chainsmokers': 'The Chainsmokers',
                    'coldplay': 'Coldplay',
                    'radiohead': 'Radiohead',
                    'hozier': 'Hozier',
                    'ac/dc': 'AC/DC',
                    'guns n roses': "Guns N' Roses",
                    'led zeppelin': 'Led Zeppelin'
                };

                let result = text;
                for (const [lower, proper] of Object.entries(properNouns)) {
                    const regex = new RegExp(`\\b${this.escapeRegex(lower)}\\b`, 'gi');
                    result = result.replace(regex, proper);
                }

                // Capitalize first letter of each word not in properNouns
                return result.replace(/\b\w+/g, word => {
                    const lower = word.toLowerCase();
                    return properNouns[lower] || this.capitalizeWord(word);
                });
            }

            generateOutput() {
                let output = `Lesson Recap`;
                
                if (this.studentName) {
                    output += ` - ${this.studentName}`;
                }
                
                if (this.finalizeDate) {
                    output += ` (Finalized: ${this.finalizeDate})`;
                }
                
                output += `\n\nToday's Achievements:\n\n`;
                
                if (this.achievements.length > 0) {
                    this.achievements.forEach(achievement => {
                        output += `• ${achievement}\n`;
                    });
                } else {
                    output += `• Successfully completed lesson activities.\n`;
                }
                
                output += `\nPractice Assignments:\n\n`;
                
                this.homework.forEach(hw => {
                    output += `• ${hw}\n`;
                });

                if (this.techniques.size > 2) {
                    output += `\nTechniques Covered:\n\n`;
                    const techniqueList = Array.from(this.techniques).slice(0, 5);
                    techniqueList.forEach(technique => {
                        output += `• ${this.capitalizeProperNouns(technique)}\n`; // Capitalize techniques for polish
                    });
                }

                return output;
            }

            saveToHistory() {
                if (!this.studentName) return;
                const history = JSON.parse(localStorage.getItem('lessonHistory') || '{}');
                if (!history[this.studentName]) {
                    history[this.studentName] = [];
                }
                const note = {
                    content: this.generateOutput(),
                    date: new Date().toISOString(),
                    isFinalized: this.isFinalized
                };
                // Check for reuse: require at least one char change if loading past
                const lastNote = history[this.studentName][history[this.studentName].length - 1];
                if (lastNote && lastNote.content === note.content) {
                    showError('Cannot save identical note. Make at least one change.');
                    return false;
                }
                history[this.studentName].push(note);
                localStorage.setItem('lessonHistory', JSON.stringify(history));
                return true;
            }
        }

        // Global formatter instance
        const formatter = new LessonFormatter();

        // Main functions
        function formatNotes() {
            const input = document.getElementById('lessonNotes').value.trim();
            const studentInput = document.getElementById('studentName').value.trim();
            
            if (!input || input.length < CONFIG.MIN_TEXT_LENGTH) {
                showError('Please enter at least 10 characters of lesson notes.');
                return;
            }

            if (input.length > CONFIG.MAX_CHARS) {
                showError(`Notes exceed ${CONFIG.MAX_CHARS} characters. Please shorten.`);
                return;
            }

            hideMessages();
            showProcessing(true);
            document.getElementById('finalizeBar').classList.add('show');
            
            // Use setTimeout to allow UI to update
            setTimeout(() => {
                try {
                    formatter.reset();
                    formatter.parseSentences(input);
                    const output = formatter.generateOutput();
                    
                    document.getElementById('output').textContent = output;
                    showProcessing(false);
                    showSuccess('Lesson recap generated successfully!');
                    
                } catch (error) {
                    console.error('Error formatting notes:', error);
                    showProcessing(false);
                    showError('An error occurred while formatting. Please try again.');
                    
                    // Fallback formatting
                    const fallbackOutput = createFallbackOutput(input);
                    document.getElementById('output').textContent = fallbackOutput;
                }
            }, 100);
        }

        function createFallbackOutput(input) {
            const lines = input.split(/[.!?]+/).filter(line => line.trim());
            let output = 'Lesson Recap\n\nToday\'s Achievements:\n\n';
            
            lines.slice(0, 3).forEach(line => {
                if (line.trim()) {
                    output += `• ${line.trim()}.\n`;
                }
            });
            
            output += '\nPractice Assignments:\n\n';
            output += '• Practice the material covered in today\'s lesson.\n';
            output += '• Focus on maintaining proper technique.\n';
            
            return output;
        }

        function finalizeNote() {
            if (!formatter.studentName) {
                showError('Please enter a student name and generate a recap first.');
                return;
            }
            if (formatter.isFinalized) {
                showError('Note is already finalized.');
                return;
            }
            const saved = formatter.saveToHistory();
            if (saved) {
                formatter.isFinalized = true;
                formatter.finalizeDate = new Date().toLocaleString();
                document.getElementById('output').textContent = formatter.generateOutput();
                document.getElementById('output').classList.add('finalized');
                document.getElementById('finalizeBar').classList.remove('show');
                showSuccess(`Note finalized and saved on ${formatter.finalizeDate}`);
            }
        }

        function viewHistory() {
            const student = document.getElementById('studentName').value.trim() || formatter.studentName;
            if (!student) {
                showError('Please enter a student name to view history.');
                return;
            }
            const history = JSON.parse(localStorage.getItem('lessonHistory') || '{}');
            const studentHistory = history[student] || [];
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            if (studentHistory.length === 0) {
                historyList.innerHTML = '<div class="history-item">No history found.</div>';
            } else {
                studentHistory.slice(-10).reverse().forEach(note => { // Show last 10
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `<strong>${new Date(note.date).toLocaleDateString()}</strong> - ${note.isFinalized ? 'Finalized' : 'Draft'}<br>${note.content.substring(0, 100)}...`;
                    item.onclick = () => loadFromHistory(note.content, student);
                    historyList.appendChild(item);
                });
            }
            document.getElementById('historySection').style.display = 'block';
            showSuccess(`Showing history for ${student}`);
        }

        function loadFromHistory(content, student) {
            document.getElementById('lessonNotes').value = content.replace(/Lesson Recap.*\n\n/, '').replace(/\n\n.*$/s, ''); // Strip header/footer
            document.getElementById('studentName').value = student;
            document.getElementById('historySection').style.display = 'none';
            showSuccess('Loaded from history. Make changes and regenerate.');
        }

        function loadExample(key) {
            const example = examples[key];
            if (example) {
                const [name, notes] = example.split(' - ', 2);
                document.getElementById('studentName').value = name.trim();
                document.getElementById('lessonNotes').value = notes || example;
                updateCharCount();
                hideMessages();
            }
        }

        function clearAll() {
            document.getElementById('studentName').value = '';
            document.getElementById('lessonNotes').value = '';
            document.getElementById('output').textContent = 'Your formatted lesson recap will appear here...';
            document.getElementById('output').classList.remove('finalized');
            document.getElementById('finalizeBar').classList.remove('show');
            document.getElementById('historySection').style.display = 'none';
            updateCharCount();
            hideMessages();
            formatter.reset();
        }

        function copyOutput() {
            const output = document.getElementById('output').textContent;
            
            if (!output || output === 'Your formatted lesson recap will appear here...') {
                showError('No content to copy. Please generate a recap first.');
                return;
            }
            
            navigator.clipboard.writeText(output)
                .then(() => {
                    showSuccess('Copied to clipboard!');
                })
                .catch(() => {
                    // Fallback method
                    const textarea = document.createElement('textarea');
                    textarea.value = output;
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    try {
                        document.execCommand('copy');
                        showSuccess('Copied to clipboard!');
                    } catch (err) {
                        showError('Unable to copy. Please select and copy manually.');
                    }
                    
                    document.body.removeChild(textarea);
                });
        }

        function showProcessing(show) {
            document.getElementById('processing').style.display = show ? 'flex' : 'none';
            document.getElementById('formatBtn').disabled = show;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorElement.style.display = 'flex';
            setTimeout(hideMessages, 5000);
        }

        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            document.getElementById('successText').textContent = message;
            successElement.style.display = 'flex';
            setTimeout(hideMessages, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function updateCharCount() {
            const text = document.getElementById('lessonNotes').value;
            const count = text.length;
            const charCountEl = document.getElementById('charCount');
            charCountEl.textContent = `${count} / ${CONFIG.MAX_CHARS} characters`;
            charCountEl.className = 'char-count';
            if (count > CONFIG.MAX_CHARS * 0.8) {
                charCountEl.classList.add('warning');
            }
            if (count > CONFIG.MAX_CHARS) {
                charCountEl.classList.add('danger');
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Character count update
            document.getElementById('lessonNotes').addEventListener('input', updateCharCount);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        formatNotes();
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        e.preventDefault();
                        clearAll();
                    } else if (e.key === 'f') {
                        e.preventDefault();
                        finalizeNote();
                    } else if (e.key === 'h') {
                        e.preventDefault();
                        viewHistory();
                    }
                }
            });
        });

        // Error handling for uncaught errors
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            showError('An unexpected error occurred. Please refresh and try again.');
        });
    </script>
</body>
</html>
